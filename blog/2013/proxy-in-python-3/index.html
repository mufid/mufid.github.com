
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="id"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Membuat Proxy Server di Python 3 - Mufid's Code blog</title>
  <meta name="author" content="Mufid">

  
  <meta name="description" content="Wah lama gak ngepost :D Baiklah, jadi ceritanya ada tugas jaringan komputer dan ini membuat Proxy. Mari kita buat hidup kita lebih sederhana dengan &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://mufid.github.io/2013/proxy-in-python-3/">
  <link href="/blog/favicon.png" rel="icon">
  <link href="/blog/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/blog/javascripts/modernizr-2.0.js"></script>
  <script src="/blog/javascripts/ender.js"></script>
  <script src="/blog/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="Mufid's Code blog" type="application/atom+xml">
  <link href='http://fonts.googleapis.com/css?family=Lato:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="https://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="https://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-61504096-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <div id="logo">
  	<div id="logoLeft">{</div>
  	<div id="logoText">mob</div>
  	<div id="logoRight">}</div>
  	<div class="clear"></div>
  </div>
  <h1><a href="/blog/">Mufid's Code blog</a></h1>
  
  <div class="clear"></div>
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:mufid.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/blog/">Blog</a></li>
  <li><a href="/blog/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      
        <h1 class="entry-title">Membuat Proxy Server di Python 3</h1>
      
    
    
      <p class="meta">
        








  


<time datetime="2013-12-08T04:58:00+07:00" pubdate data-updated="true">Dec 8<span>th</span>, 2013</time>
        
         | <a href="#disqus_thread">Comments</a>
        
      </p>
    
  </header>


<div class="entry-content"><p>Wah lama gak ngepost :D</p>

<p>Baiklah, jadi ceritanya ada tugas jaringan komputer dan ini membuat Proxy. Mari kita buat hidup kita lebih sederhana dengan memahami bagaimana proxy bekerja.</p>

<p>Berhubung ini adalah post Proof of Concept, maka post kali ini akan sangat panjang. Pastikan Anda sudah membeli Siomay atau Pizza untuk menemani Anda membaca post ini. Atau Anda juga dapat <a href="http://myanimelist.net/anime/6547/Angel_Beats!">menyiapkan anime yang menggugah semangat untuk menambah semangat Anda dalam membaca post ini</a>.</p>

<p>Selamat menikmati! (makanan dan postnya, tentu saja).</p>

<p>(Note: Saya mohon kritik Anda apabila penjelasan saya di sini ada yang misleading atau sulit dipahami. Dengan demikian saya bisa menghasilkan tulisan dengan kualitas tulisan yang lebih baik lagi ^_^)</p>

<!-- more -->


<h2>The Tools</h2>

<p>Agar hidup ini lebih menyenangkan saat menggunakkan Windows, saya menggunakkan beberapa perkakas seperti Mingw dan PyCharm. Semua tools tersebut tersedia gratis di internet.</p>

<h2>The Proxy</h2>

<p><code>mahasiswa.cs.ui.ac.id</code> adalah sebuah server web yang melayani halaman <code>public_html</code> dari setiap <code>~</code> (home folder) mahasiswa CSUI ke internet publik. Mari kita lihat apa yang terjadi apabila saya membuka halaman web mahasiswa.cs.ui.ac.id. Tentu saja, di sini saya memakai &ldquo;debug mode&rdquo;. Kita gunakan <code>curl</code> dengan verbose mode agar dapat mengetahui apa yang sebenarnya terjadi.</p>

<pre><code>D:\tmp&gt;curl -v mahasiswa.cs.ui.ac.id
* Adding handle: conn: 0x4c2cf0
* Adding handle: send: 0
* Adding handle: recv: 0
* Curl_addHandleToPipeline: length: 1
* - Conn 0 (0x4c2cf0) send_pipe: 1, recv_pipe: 0
* About to connect() to mahasiswa.cs.ui.ac.id port 80 (#0)
*   Trying 152.118.148.93...
* Connected to mahasiswa.cs.ui.ac.id (152.118.148.93) port a80 (#0)
&gt; GET / HTTP/1.1
&gt; User-Agent: curl/7.30.0
&gt; Host: mahasiswa.cs.ui.ac.id
&gt; Accept: */*
&gt;
&lt; HTTP/1.1 200 OK
&lt; Date: Sat, 07 Dec 2013 22:01:58 GMT
* Server Apache/2.2.22 (Debian) is not blacklisted
&lt; Server: Apache/2.2.22 (Debian)
&lt; Last-Modified: Tue, 27 Mar 2012 14:08:11 GMT
&lt; ETag: "5ba68-b1-4bc3a055dc8c0"
&lt; Accept-Ranges: bytes
&lt; Content-Length: 177
&lt; Vary: Accept-Encoding
&lt; Content-Type: text/html
&lt; Via: 1.1 mahasiswa.cs.ui.ac.id
&lt;
&lt;html&gt;&lt;body&gt;&lt;h1&gt;It works!&lt;/h1&gt;
&lt;p&gt;This is the default web page for this server.&lt;/p&gt;
&lt;p&gt;The web server software is running but no content has been added, yet.&lt;/p&gt;
&lt;/body&gt;&lt;/html&gt;
* Connection #0 to host mahasiswa.cs.ui.ac.id left intact

D:\tmp&gt;
</code></pre>

<p><strong>Apa yang sebenarnya terjadi?</strong></p>

<p>Dalam mengakses internet, client (bisa browser, bisa program kecil seperti curl/wget, etc.) akan membuka koneksi ke server melalui socket. Apa yang client kirimkan setelah membuka koneksi? Mengirimkan baris-baris yang ditandai dengan <code>&gt;</code>. Setelah <code>\r\n</code> kosong, server akan menganggap client selesai mengirimkan <strong>HTTP Request</strong> dan akan memulai memberikan respons (<strong>HTTP Response</strong>) yang ditandai dengan <code>&lt;</code>.</p>

<p>Tugas Proxy sederhana. Dia menjadi jembatan antara Client dan Server. Tetapi yang menarik adalah <strong>Proxy behave sebagai server sungguhan dengan hanya menyunting satu baris saja</strong>. Kita lihat apa yang terjadi jika kita mengatur proxy di komputer kita. Kali ini saya akan memakai proxy fiktif. Fokus kita di sini adalah mengetahui bagian apa yang berubah.</p>

<pre><code>D:\tmp&gt;set HTTP_PROXY=http://example.com:80

D:\tmp&gt;curl mahasiswa.cs.ui.ac.id -v
* Adding handle: conn: 0x4c2d10
* Adding handle: send: 0
* Adding handle: recv: 0
* Curl_addHandleToPipeline: length: 1
* - Conn 0 (0x4c2d10) send_pipe: 1, recv_pipe: 0
* About to connect() to proxy example.com port 80 (#0)
*   Trying 93.184.216.119...
* Connected to example.com (93.184.216.119) port 80 (#0)
&gt; GET HTTP://mahasiswa.cs.ui.ac.id/ HTTP/1.1
&gt; User-Agent: curl/7.30.0
&gt; Host: mahasiswa.cs.ui.ac.id
&gt; Accept: */*
&gt; Proxy-Connection: Keep-Alive
&gt;
* HTTP 1.0, assume close after body
&lt; HTTP/1.0 400 Bad Request
&lt; Content-Type: text/html
&lt; Content-Length: 349
&lt; Connection: close
&lt; Date: Sat, 07 Dec 2013 22:10:10 GMT
&lt; Server: ECSF (cpm/F9B9)
&lt;
&lt;?xml version="1.0" encoding="iso-8859-1"?&gt;
&lt;!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
         "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"&gt;
&lt;html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en"&gt;
        &lt;head&gt;
                &lt;title&gt;400 - Bad Request&lt;/title&gt;
        &lt;/head&gt;
        &lt;body&gt;
                &lt;h1&gt;400 - Bad Request&lt;/h1&gt;
        &lt;/body&gt;
&lt;/html&gt;
* Closing connection 0

D:\tmp&gt;
</code></pre>

<p>Lihat bagian yang berubah? Pertama lihat baris pertama. Tadinya adalah alamat relatif terhadap host. Sekarang adalah alamat absolut. Yosh, hanya bagian itu saja. Sisanya, proxy hanya meneruskan data-data dari server (sebetulnya bisa iseng sedikit seperti mengambil password, tetapi itu di luar bahasan kita).</p>

<h2>In a Nutshell (Dalam Kulit Kacang)</h2>

<pre><code>Client
  |       Proxy bertindak seolah-olah sebagai server*
  |       jika dilihat oleh client
  |
Proxy
  |       Proxy bertindak seolah-olah sebagai client
  |       jika dilihat oleh server
  |
Server
</code></pre>

<h2>The Code</h2>

<p>Kode Templatenya adalah sebagai berikut:</p>

<figure class='code'><figcaption><span>proxy-keren.py </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'>   <span class="kn">from</span> <span class="nn">socket</span> <span class="kn">import</span> <span class="o">*</span>
</span><span class='line'>  <span class="kn">import</span> <span class="nn">sys</span>
</span><span class='line'>
</span><span class='line'>  <span class="c"># Create a server socket, bind it to a port and start listening</span>
</span><span class='line'>  <span class="n">tcpSerSock</span> <span class="o">=</span> <span class="n">socket</span><span class="p">(</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="p">)</span>
</span><span class='line'>  <span class="c"># Fill in start.</span>
</span><span class='line'>  <span class="c"># PART 1</span>
</span><span class='line'>  <span class="c"># Fill in end.</span>
</span><span class='line'>  <span class="k">while</span> <span class="mi">1</span><span class="p">:</span>
</span><span class='line'>    <span class="c"># Strat receiving data from the client</span>
</span><span class='line'>    <span class="k">print</span> <span class="p">(</span><span class="s">&quot;Ready to serve...&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="n">tcpCliSock</span><span class="p">,</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">tcpSerSock</span><span class="o">.</span><span class="n">accept</span><span class="p">()</span>
</span><span class='line'>    <span class="n">message</span> <span class="o">=</span> <span class="c"># PART 2</span>
</span><span class='line'>    <span class="k">print</span> <span class="p">(</span><span class="n">message</span><span class="p">)</span>
</span><span class='line'>    <span class="c"># Extract the filename from the given message</span>
</span><span class='line'>    <span class="k">print</span> <span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">])</span>
</span><span class='line'>    <span class="n">filename</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">partition</span><span class="p">(</span><span class="s">&quot;/&quot;</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span>
</span><span class='line'>    <span class="k">print</span> <span class="p">(</span><span class="n">filename</span><span class="p">)</span>
</span><span class='line'>    <span class="n">fileExist</span> <span class="o">=</span> <span class="s">&quot;false&quot;</span>
</span><span class='line'>    <span class="n">filetouse</span> <span class="o">=</span> <span class="s">&quot;/&quot;</span> <span class="o">+</span> <span class="n">filename</span>
</span><span class='line'>    <span class="k">print</span> <span class="p">(</span><span class="n">filetouse</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">try</span><span class="p">:</span>
</span><span class='line'>      <span class="c"># Check wether the file exist in the cache</span>
</span><span class='line'>      <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filetouse</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="s">&quot;r&quot;</span><span class="p">)</span>
</span><span class='line'>      <span class="n">outputdata</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
</span><span class='line'>      <span class="n">fileExist</span> <span class="o">=</span> <span class="s">&quot;true&quot;</span>
</span><span class='line'>      <span class="c"># ProxyServer finds a cache hit and generates a response message</span>
</span><span class='line'>      <span class="n">tcpCliSock</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s">&quot;HTTP/1.0 200 OK</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">)</span>
</span><span class='line'>      <span class="n">tcpCliSock</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s">&quot;Content-Type:text/html</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">)</span>
</span><span class='line'>      <span class="c"># Fill in start. # PART 3</span>
</span><span class='line'>      <span class="c"># Fill in end.</span>
</span><span class='line'>      <span class="k">print</span> <span class="p">(</span><span class="s">&quot;Read from cache&quot;</span><span class="p">)</span>
</span><span class='line'>      <span class="c"># Error handling for file not found in cache</span>
</span><span class='line'>    <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
</span><span class='line'>      <span class="k">if</span> <span class="n">fileExist</span> <span class="o">==</span> <span class="s">&quot;false&quot;</span><span class="p">:</span>
</span><span class='line'>        <span class="c"># Create a socket on the proxyserver</span>
</span><span class='line'>        <span class="c"># c = # Fill in start. # Fill in end. # PART 4</span>
</span><span class='line'>        <span class="n">hostn</span> <span class="o">=</span> <span class="n">filename</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;www.&quot;</span><span class="p">,</span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
</span><span class='line'>        <span class="k">print</span> <span class="p">(</span><span class="n">hostn</span><span class="p">)</span>
</span><span class='line'>        <span class="k">try</span><span class="p">:</span>
</span><span class='line'>          <span class="c"># Connect to the socket to port 80</span>
</span><span class='line'>          <span class="c"># Fill in start. # PART 5</span>
</span><span class='line'>          <span class="c"># Fill in end.</span>
</span><span class='line'>          <span class="c"># Create a temporary file on this socket and ask port 80 for the file requested by the client</span>
</span><span class='line'>          <span class="n">fileobj</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">makefile</span><span class="p">(</span><span class="s">&#39;rwb&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span class='line'>          <span class="n">strHeader</span><span class="o">=</span><span class="nb">str</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&quot;GET &quot;</span><span class="o">+</span><span class="s">&quot;http://&quot;</span> <span class="o">+</span> <span class="n">filename</span> <span class="o">+</span> <span class="s">&quot; HTTP/1.0</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">)</span>
</span><span class='line'>          <span class="n">fileobj</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">strHeader</span><span class="p">)</span>
</span><span class='line'>          <span class="c"># Read the response into buffer</span>
</span><span class='line'>          <span class="c"># Fill in start. # PART 6</span>
</span><span class='line'>          <span class="c"># Fill in end.</span>
</span><span class='line'>          <span class="c"># Create a new file in the cache for the requested file.</span>
</span><span class='line'>          <span class="c"># Also send the response in the buffer to client socket</span>
</span><span class='line'>          <span class="c"># and the corresponding file in the cache</span>
</span><span class='line'>          <span class="n">tmpFile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">&quot;./&quot;</span> <span class="o">+</span> <span class="n">filename</span><span class="p">,</span><span class="s">&quot;wb&quot;</span><span class="p">)</span>
</span><span class='line'>          <span class="c"># Fill in start. # PART 7</span>
</span><span class='line'>          <span class="c"># Fill in end.</span>
</span><span class='line'>        <span class="k">except</span><span class="p">:</span>
</span><span class='line'>         <span class="k">print</span> <span class="p">(</span><span class="s">&quot;Illegal request&quot;</span><span class="p">)</span>
</span><span class='line'>      <span class="k">else</span><span class="p">:</span>
</span><span class='line'>         <span class="c"># HTTP response message for file not found</span>
</span><span class='line'>         <span class="c"># Fill in start. # PART 8</span>
</span><span class='line'>         <span class="c"># Fill in end.</span>
</span><span class='line'>         <span class="c"># Close the client and the server sockets</span>
</span><span class='line'>         <span class="n">tcpCliSock</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>  <span class="c"># Fill in start. # PART 9</span>
</span><span class='line'>  <span class="c"># Fill in end.</span>
</span></code></pre></td></tr></table></div></figure>


<p>Mari kita mulai mengoding ~</p>

<h2>Part 1</h2>

<p>Bagian yang paling mudah. Karena proxy bertindak seolah-olah sebagai server terhadap client, maka proxy harus membuka koneksi port ke client.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'>   <span class="n">tcpSerSock</span><span class="o">.</span><span class="n">bind</span><span class="p">((</span><span class="s">&quot;127.0.0.1&quot;</span><span class="p">,</span> <span class="mi">8888</span><span class="p">))</span>
</span><span class='line'>  <span class="n">tcpSerSock</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Sepertinya baris kode tersebut self-explanatory, tidak perlu dijelaskan. Mungkin yang perlu Anda perhatikan di bagian <code>listen</code>. Apa maksud dari angka di <code>listen</code>? Baca <a href="http://docs.python.org/3.3/library/socket.html#socket.socket.listen">dokumentasinya</a> saja ya :D</p>

<blockquote><p><strong>socket.listen(backlog)</strong>
Listen for connections made to the socket. The backlog argument specifies the maximum number of queued connections and should be at least 0; the maximum value is system-dependent (usually 5), the minimum value is forced to 0.</p></blockquote>

<h2>Part 2</h2>

<p>Bagian ini adalah bagian menerima koneksi dari client. Bagian ini agak tricky, tapi kita mulai dengan hal yang paling sampah terlebih dahulu:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'>     <span class="n">data</span> <span class="o">=</span> <span class="n">tcpCliSock</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</span><span class='line'>    <span class="k">print</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span><span class='line'>    <span class="n">message</span> <span class="o">=</span> <span class="n">data</span>
</span></code></pre></td></tr></table></div></figure>


<p>Mari kita coba bermain dengan curl lagi (jangan lupa menjalankan script python kesayangan kita ini terlebih dahulu). Tentu saja Anda dapat mengujinya dengan browser, tetapi buat saya atas-enter-atas-enter lebih menyenangkan daripada Alt-tab-mouse-klikkiri-go-f5-ctrlF5.</p>

<pre><code>D:\tmp&gt;python proxy-keren.py
Ready to serve...
Received a connection from: ('127.0.0.1', 52799)
b'GET HTTP:/'
b'HTTP:/'
</code></pre>

<p>Kenapa kita hanya menerima 10 byte pertama saja? Karena kita mengatur buffer untuk proxy kita hanya 10 byte. Sebetulnya, kita tinggal mengganti saja menjadi > 10 byte. Tetapi ada constraint berikut di <a href="http://docs.python.org/3.3/library/socket.html#socket.socket.recv">dokumentasi Python</a>:</p>

<blockquote><p><strong>socket.recv(bufsize[, flags])</strong>
Receive data from the socket. The return value is a bytes object representing the data received. The maximum amount of data to be received at once is specified by bufsize. See the Unix manual page recv(2) for the meaning of the optional argument flags; it defaults to zero.</p></blockquote>

<p>Kalau begitu, sebagaimana kita membaca file, mari kita baca socket hingga tidak ada isinya lagi. Ubah sedikit kodenya:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'>     <span class="n">emptybyte</span> <span class="o">=</span> <span class="bp">False</span>
</span><span class='line'>    <span class="n">message</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">()</span>
</span><span class='line'>    <span class="k">while</span> <span class="p">(</span><span class="ow">not</span> <span class="n">emptybyte</span><span class="p">):</span>
</span><span class='line'>      <span class="n">chunk</span> <span class="o">=</span> <span class="n">tcpCliSock</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span>
</span><span class='line'>        <span class="k">print</span> <span class="p">(</span><span class="s">&quot;Chunk is&quot;</span><span class="p">)</span>
</span><span class='line'>      <span class="k">print</span> <span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
</span><span class='line'>      <span class="k">if</span> <span class="n">chunk</span> <span class="o">==</span> <span class="n">b</span><span class="s">&#39;&#39;</span><span class="p">:</span>
</span><span class='line'>        <span class="n">emptybyte</span> <span class="o">=</span> <span class="bp">True</span>
</span><span class='line'>      <span class="k">else</span><span class="p">:</span>
</span><span class='line'>        <span class="n">message</span> <span class="o">+=</span> <span class="n">chunk</span>
</span><span class='line'>    <span class="k">print</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p><strong>Catatan Tambahan:</strong> Sebetulnya Anda bisa saja memperbesar jumlah buffernya dan tidak melakukan looping, tetapi itu bukan implementasi yang baik. Meski implementasi chunk di sini lebih baik dibandingkan memperbesar buffer and do nothing, Anda tetap harus memikirkan kondisi terburuk semisal koneksi terputus di tengah jalan. Meski demikian, kita akan mengabaikan hal-hal seperti ini. Kita tidak sedang membuat proxy terbaik, tetapi kita sedang membuat proof of concept dari proxy.</p>

<p>Nanti dulu, kalau kita jalankan proxynya, kita akan terjebak dalam forever loop. NOOOO!!</p>

<pre><code>D:\tmp&gt;python proxy-keren.py
Ready to serve...
Received a connection from: ('127.0.0.1', 53905)
Chunk is
b'GET HTTP://mahas'
Chunk is
b'iswa.cs.ui.ac.id'
Chunk is
b'/ HTTP/1.1\r\nUser'
Chunk is
b'-Agent: curl/7.3'
Chunk is
b'0.0\r\nHost: mahas'
Chunk is
b'iswa.cs.ui.ac.id'
Chunk is
b'\r\nAccept: */*\r\nP'
Chunk is
b'roxy-Connection:'
Chunk is
b' Keep-Alive\r\n\r\n'
</code></pre>

<p>Program berhenti di sana. Kenapa? Karena koneksi socket pasti akan selalu terjalin, kecuali client sudah menerima apa yang dia inginkan. Sedangkan di sini koneksi socket terjalin tetapi si client masih menunggu jawaban dari proxy. &ldquo;Woy gw minta halaman mahasiswa.cs.ui.ac.id donk!&rdquo; Dia akan terus menunggu dan menjalin hubungan hingga proxy memberikan balasannya. Maka dari itu kita terjebak dalam forever loop.</p>

<p>Client selesai memberikan informasi &ldquo;gw butuh apa&rdquo; setelah ada <code>\r\n\r\n</code> sesuai dengan spesifikasi <a href="http://www.apps.ietf.org/rfc/rfc3507.html">RFC 3507</a>. Maka dari itu, mari kita ubah sedikit kodenya:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>emptybyte = False
</span><span class='line'>    message = bytes()
</span><span class='line'>    while (not emptybyte):
</span><span class='line'>      chunk = tcpCliSock.recv(16)
</span><span class='line'>      print("Chunk is ")
</span><span class='line'>      print(chunk)
</span><span class='line'>      message += chunk
</span><span class='line'>      if message.endswith(bytes('\r\n\r\n'.encode('utf-8'))):
</span><span class='line'>        emptybyte = True</span></code></pre></td></tr></table></div></figure>


<p>Hasilnya:</p>

<pre><code>D:\tmp&gt;python proxy-keren.py
Ready to serve...
Received a connection from: ('127.0.0.1', 53948)
b'GET HTTP://mahasiswa.cs.ui.ac.id/ HTTP/1.1\r\nUser-Agent: curl/7.30.0\r\nHost: mahasiswa.cs.ui.ac.id\r\nAccept: */*\r\nProxy-Con
nection: Keep-Alive\r\n\r\n'
b'HTTP://mahasiswa.cs.ui.ac.id/'
Traceback (most recent call last):
  File "proxy-keren.py", line 26, in &lt;module&gt;
    filename = message.split()[1].partition("/")[2]
TypeError: expected bytes, bytearray or buffer compatible object
</code></pre>

<p>Terjadi kesalahan karena pada template asli, program berusaha untuk menganalisis data bytes yang dianggap sebagai string. Mudah sekali, ubah saja menjadi string</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'>   <span class="n">message_raw</span> <span class="o">=</span> <span class="n">message</span>
</span><span class='line'>  <span class="n">message</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">&#39;utf-8&#39;</span><span class="p">)</span>
</span><span class='line'>  <span class="k">print</span> <span class="p">(</span><span class="n">message</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Message asli saya preserve dalam message_raw untuk kebutuhan kita di masa depan. Anda akan mengerti setelah beberapa puluh paragraf ini.</p>

<p>Tentu proxynya masih belum berjalan dengan baik dengan modifikasi ini. Mari kita lanjut ke part 4. What? Part 4? Iya, karena part 3 adalah fungsi membaca dari cache, sedangkan kita belum mengimplementasi fungsi menulis ke cache. Kalau tidak ada yang ditulis, mau baca apa?</p>

<h2>Part 4</h2>

<p>Bagian ini mengatur bagaimana koneksi proxy ke server. Skenario aslinya adalah:</p>

<ul>
<li>Jika cache hit (halaman tersedia di cache), maka baca dari cache (Part 3).</li>
<li>Jika tidak, maka berikan client data dari server (Part 4, ini).</li>
</ul>


<p>Bagaimana kalau kita iseng? Jadi kita lakukan ini:</p>

<ol>
<li>Memberikan seluruh data dari client ke server</li>
<li>Mengembalikan ke client seluruh data yang diterime oleh proxy dari server</li>
</ol>


<p>BRILLIANT IDEA!?</p>

<p>No.</p>

<p>Karena kita harus mengubah baris pertama dari HTTP Request. Tetapi, mari kita coba dengan cara yang naive terlebih dahulu.</p>

<p>Tetapi sebelumnya, saya melihat kejanggalan di template ini. Mari kita lihat isi dari <code>filename</code> dari <code>hostn</code>:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'>      <span class="n">hostn</span> <span class="o">=</span> <span class="n">filename</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;www.&quot;</span><span class="p">,</span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
</span><span class='line'>      <span class="k">print</span><span class="p">(</span><span class="s">&quot;filename is &quot;</span> <span class="o">+</span> <span class="n">filename</span><span class="p">)</span>
</span><span class='line'>      <span class="k">print</span><span class="p">(</span><span class="s">&quot;hostn is &quot;</span> <span class="o">+</span> <span class="n">hostn</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Hasilnya:</p>

<pre><code># window 1
curl -v mahasiswa.cs.ui.ac.id/dadadada/dadskjfkdsljfskdljf

# window 2
...
filename is /mahasiswa.cs.ui.ac.id/dadadada/dadskjfkdsljfskdljf
hostn is /mahasiswa.cs.ui.ac.id/dadadada/dadskjfkdsljfskdljf
</code></pre>

<p>Seriously, hostnamenya adalah URI?</p>

<p>Kalau begitu, gunakan saja URI Parser dari Python.</p>

<p>Import modul berikut:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'>   <span class="kn">from</span> <span class="nn">urllib.parse</span> <span class="kn">import</span> <span class="n">urlparse</span>
</span></code></pre></td></tr></table></div></figure>


<p>Ubah beberapa bagian di bawah Part 1:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'>     <span class="k">print</span> <span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">])</span>
</span><span class='line'>    <span class="n">parsed_url</span> <span class="o">=</span> <span class="n">urlparse</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">])</span>
</span></code></pre></td></tr></table></div></figure>


<p>Di part 4 menjadi:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'>      <span class="n">hostn</span> <span class="o">=</span> <span class="n">parsed_url</span><span class="o">.</span><span class="n">netloc</span>
</span><span class='line'>      <span class="n">filename</span> <span class="o">=</span> <span class="n">parsed_url</span><span class="o">.</span><span class="n">path</span>
</span><span class='line'>      <span class="n">port</span> <span class="o">=</span> <span class="mi">80</span> <span class="k">if</span> <span class="bp">None</span> <span class="o">==</span> <span class="n">parsed_url</span><span class="o">.</span><span class="n">port</span> <span class="k">else</span> <span class="n">parsed_url</span><span class="o">.</span><span class="n">port</span>
</span><span class='line'>    <span class="n">full_path</span> <span class="o">=</span> <span class="n">hostn</span> <span class="o">+</span> <span class="n">filename</span>
</span><span class='line'>      <span class="n">c</span> <span class="o">=</span> <span class="n">socket</span><span class="p">(</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Jalankan kembali proxynya. Tadaaa!</p>

<pre><code>filename is /dadadada/dadskjfkdsljfskdljf
hostn is mahasiswa.cs.ui.ac.id
</code></pre>

<p>Baiklah, tinggal satu langkah lagi. Mari buat koneksi baru dan mulai segalanya dari sini.</p>

<p><strong>Catatan</strong>: Di sini saya tidak membuat port default adalah 80, karena sangat jelas: akses HTTP belum tentu hanya di port 80. Practically, bisa dimanapun.</p>

<p><strong>Catatan 2</strong>: Saya membuat full_path untuk menyimpan cache. Kita akan gunakan di part selanjutnya.</p>

<h2>Part 5</h2>

<p>Nothing to do here:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'>   <span class="n">c</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">hostn</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Melakukan sambungan harus dalam blok try-catch.</p>

<h2>Part 5+</h2>

<p>Saya menemukan kesalahan dalam template yang menggunakkan <code>\n\n</code> untuk line ending (yang seharusnya <code>\r\n</code>). Kemudian tidak adanya request header <code>Host</code> yang mana itu dibutuhkan oleh dispatcher / router untuk web worker. Baiklah, mari kita rubah sedikit pada bagian tersebut.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'>        <span class="n">strHeader</span> <span class="o">=</span> <span class="nb">str</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&quot;GET &quot;</span> <span class="o">+</span> <span class="n">full_path</span> <span class="o">+</span> <span class="s">&quot; HTTP/1.0</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">)</span>
</span><span class='line'>      <span class="n">strHeader</span> <span class="o">+=</span> <span class="nb">str</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&quot;Host: &quot;</span> <span class="o">+</span> <span class="n">hostn</span> <span class="o">+</span> <span class="s">&quot;</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">)</span>
</span><span class='line'>      <span class="n">strHeader</span> <span class="o">+=</span> <span class="nb">str</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">)</span>
</span><span class='line'>        <span class="n">fileobj</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">strHeader</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Part 6</h2>

<p>Lakukan hal yang serupa seperti saat kita membaca socket dari client. Tetapi berhubung template kita sudah menggunakkan makefile, jadi kehidupan kita sedikit lebih mudah.</p>

<blockquote><p><strong>Mengapa saat koneksi Client-Proxy kita tidak bisa menggunakkan makefile?</strong> Saya belum tahu. Dugaan saya adalah karena client masih menunggu jawaban, tetapi mungkin Anda tertarik untuk mencoba pendekatan yang lain. Sedangkan di sini yang menjadi client adalah proxy, dan proxy sudah mengirimkan semua informasi header yang sehingga penantian jawabannya adalah suatu kepastian (HTTP Request sudah dikirim semua, tinggal menunggu response).</p></blockquote>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'>        <span class="n">tcpCliSock</span><span class="o">.</span><span class="n">sendall</span><span class="p">(</span><span class="n">fileobj</span><span class="o">.</span><span class="n">readall</span><span class="p">())</span>
</span></code></pre></td></tr></table></div></figure>


<p>Btw, untuk sementara Anda bisa mengcomment bagian tmpFile agar program bisa berjalan dengan baik.</p>

<p>Mari kita coba lihat hasilnya pada kondisi saat ini, yihaa program berjalan sebagaimana mestinya!</p>

<pre><code>C:\Users\Mufid&gt;curl -v mahasiswa.cs.ui.ac.id/dadadada/dadskjfkdsljfskdljf
* Adding handle: conn: 0x982678
* Adding handle: send: 0
* Adding handle: recv: 0
* Curl_addHandleToPipeline: length: 1
* - Conn 0 (0x982678) send_pipe: 1, recv_pipe: 0
* About to connect() to proxy localhost port 8888 (#0)
*   Trying ::1...
* Connection refused
*   Trying 127.0.0.1...
* Connected to localhost (127.0.0.1) port 8888 (#0)
&gt; GET HTTP://mahasiswa.cs.ui.ac.id/dadadada/dadskjfkdsljfskdljf HTTP/1.1
&gt; User-Agent: curl/7.30.0
&gt; Host: mahasiswa.cs.ui.ac.id
&gt; Accept: */*
&gt; Proxy-Connection: Keep-Alive
&gt;
&lt; HTTP/1.1 404 Not Found
&lt; Date: Sun, 08 Dec 2013 02:08:55 GMT
* Server Apache/2.2.22 (Debian) is not blacklisted
&lt; Server: Apache/2.2.22 (Debian)
&lt; Vary: Accept-Encoding
&lt; Content-Length: 313
&lt; Content-Type: text/html; charset=iso-8859-1
&lt; Via: 1.0 mahasiswa.cs.ui.ac.id
&lt; Connection: close
&lt;
&lt;!DOCTYPE HTML PUBLIC "-//IETF//DTD HTML 2.0//EN"&gt;
&lt;html&gt;&lt;head&gt;
&lt;title&gt;404 Not Found&lt;/title&gt;
&lt;/head&gt;&lt;body&gt;
&lt;h1&gt;Not Found&lt;/h1&gt;
&lt;p&gt;The requested URL /dadadada/dadskjfkdsljfskdljf was not found on this server.&lt;/p&gt;
&lt;hr&gt;
&lt;address&gt;Apache/2.2.22 (Debian) Server at mahasiswa.cs.ui.ac.id Port 80&lt;/address&gt;
&lt;/body&gt;&lt;/html&gt;
* Closing connection 0
</code></pre>

<h2>Next Up: 404</h2>

<p>Berhubung di tugas disebutkan tidak ada data yang disimpan untuk halaman 404, maka ya cukup jangan simpan jika itu halaman 404. Tetapi saya agak bingung bagaimana mengimplementasi ini. Jadi saya justru melakukan perubahan di Part 6:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">&#39;utf-8&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;4&#39;</span><span class="p">)):</span>
</span><span class='line'>          <span class="n">tcpCliSock</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s">&quot;HTTP/1.1 404 Not Found&quot;</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;utf-8&#39;</span><span class="p">))</span>
</span><span class='line'>          <span class="n">tcpCliSock</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\0\r\n\r\n</span><span class="s">&quot;</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;utf-8&#39;</span><span class="p">))</span>
</span><span class='line'>          <span class="n">tcpCliSock</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span class='line'>          <span class="k">continue</span>
</span></code></pre></td></tr></table></div></figure>


<p>Bukan hanya 404, melainkan juga 4xx. Hal ini karena status 4xx menandakan kesalahan di permintaan.</p>

<pre><code>C:\Users\Mufid&gt;curl -v mahasiswa.cs.ui.ac.id/dadadada/dadskjfkdsljfskdljf
* Adding handle: conn: 0x1db2678
* Adding handle: send: 0
* Adding handle: recv: 0
* Curl_addHandleToPipeline: length: 1
* - Conn 0 (0x1db2678) send_pipe: 1, recv_pipe: 0
* About to connect() to proxy localhost port 8888 (#0)
*   Trying ::1...
* Connection refused
*   Trying 127.0.0.1...
* Connected to localhost (127.0.0.1) port 8888 (#0)
&gt; GET HTTP://mahasiswa.cs.ui.ac.id/dadadada/dadskjfkdsljfskdljf HTTP/1.1
&gt; User-Agent: curl/7.30.0
&gt; Host: mahasiswa.cs.ui.ac.id
&gt; Accept: */*
&gt; Proxy-Connection: Keep-Alive
&gt;
&lt; HTTP/1.1 404 Not Found
* no chunk, no close, no size. Assume close to signal end
&lt;
* Closing connection 0
</code></pre>

<p>Okay, sudah lebih baik. Mari kita lanjut ke proses caching.</p>

<h2>Next up: POST Request</h2>

<p>Post Request ini sangat tricky. Karena di request post, request body tidak kosong. Mari kita lihat:</p>

<pre><code>mingw $ curl -v mahasiswa.cs.ui.ac.id/~muhammad.mufid/ -XPOST -d ganteng=ya --trace-ascii /dev/stdout
Warning: --trace-ascii overrides an earlier trace/verbose option
== Info: Adding handle: conn: 0x1f739b8
== Info: Adding handle: send: 0
== Info: Adding handle: recv: 0
== Info: Curl_addHandleToPipeline: length: 1
== Info: - Conn 0 (0x1f739b8) send_pipe: 1, recv_pipe: 0
== Info: About to connect() to proxy localhost port 8888 (#0)
== Info:   Trying ::1...
== Info: Connection refused
== Info:   Trying 127.0.0.1...
== Info: Connected to localhost (127.0.0.1) port 8888 (#0)
=&gt; Send header, 229 bytes (0xe5)
0000: POST HTTP://mahasiswa.cs.ui.ac.id/~muhammad.mufid/ HTTP/1.1
003d: User-Agent: curl/7.30.0
0056: Host: mahasiswa.cs.ui.ac.id
0073: Accept: */*
0080: Proxy-Connection: Keep-Alive
009e: Content-Length: 10
00b2: Content-Type: application/x-www-form-urlencoded
00e3:
=&gt; Send data, 10 bytes (0xa)
0000: ganteng=ya
== Info: upload completely sent off: 10 out of 10 bytes
</code></pre>

<p>.. dan &hellip; loop forever.</p>

<p>Ini karena <code>\0\r\n\r\n</code> itu sebagai penanda antara request body dan request header. Maka dari itu, agar loopnya berjalan dengan baik, kita ubah sedikit programnya di bagian loop penerima request: Saya juga menambahkan <code>import re</code> di bagian tas karena kita akan menggunakkan regex agar hidup kita lebih menyenangkan</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'>     <span class="n">CHUNK_SIZE</span> <span class="o">=</span> <span class="mi">16</span>
</span><span class='line'>    <span class="n">emptybyte</span> <span class="o">=</span> <span class="bp">False</span>
</span><span class='line'>    <span class="n">message</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">()</span>
</span><span class='line'>    <span class="n">content_length</span> <span class="o">=</span> <span class="mi">0</span>
</span><span class='line'>    <span class="k">while</span> <span class="p">(</span><span class="ow">not</span> <span class="n">emptybyte</span><span class="p">):</span>
</span><span class='line'>      <span class="n">chunk</span> <span class="o">=</span> <span class="n">tcpCliSock</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="n">CHUNK_SIZE</span><span class="p">)</span>
</span><span class='line'>      <span class="n">message</span> <span class="o">+=</span> <span class="n">chunk</span>
</span><span class='line'>      <span class="c"># Receive everything until the end of the time. No just kidding</span>
</span><span class='line'>      <span class="c"># Until the end of HTTP Request. Please read RFC 3507</span>
</span><span class='line'>      <span class="k">if</span> <span class="n">message</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;</span><span class="se">\r\n\r\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;utf-8&#39;</span><span class="p">)):</span>
</span><span class='line'>        <span class="n">emptybyte</span> <span class="o">=</span> <span class="bp">True</span>
</span><span class='line'>
</span><span class='line'>      <span class="c"># Detect end of POST request</span>
</span><span class='line'>      <span class="n">regex_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s">r&quot;Content-Length: ([0-9]+)&quot;</span><span class="p">,</span> <span class="n">message</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">&#39;utf-8&#39;</span><span class="p">))</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="n">regex_match</span><span class="p">):</span>
</span><span class='line'>        <span class="n">content_length</span> <span class="o">=</span> <span class="p">(</span><span class="nb">int</span><span class="p">)</span> <span class="p">(</span><span class="n">regex_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
</span><span class='line'>        <span class="c"># Check if everything has been send as expected</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">message</span><span class="p">[</span><span class="o">-</span><span class="n">content_length</span><span class="o">-</span><span class="mi">4</span><span class="p">:</span><span class="o">-</span><span class="n">content_length</span><span class="p">]</span> <span class="o">==</span> <span class="n">b</span><span class="s">&#39;</span><span class="se">\r\n\r\n</span><span class="s">&#39;</span><span class="p">):</span>
</span><span class='line'>          <span class="n">emptybyte</span> <span class="o">=</span> <span class="bp">True</span>
</span></code></pre></td></tr></table></div></figure>


<p>Dan juga jangan lupa agar proxy mengirim ke server juga dengan request body dari client</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'>        <span class="n">fileobj</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">makefile</span><span class="p">(</span><span class="s">&#39;rwb&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span class='line'>        <span class="n">request_name</span> <span class="o">=</span> <span class="n">message_raw</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">b</span><span class="s">&#39; &#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span class='line'>        <span class="n">rest_of_request</span> <span class="o">=</span> <span class="n">message_raw</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;</span><span class="se">\r\n</span><span class="s">&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
</span><span class='line'>        <span class="n">strHeader</span> <span class="o">=</span> <span class="nb">str</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">request_name</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">&#39;utf-8&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot; &quot;</span> <span class="o">+</span> <span class="n">filename</span> <span class="o">+</span> <span class="s">&quot; HTTP/1.0</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">)</span>
</span><span class='line'>        <span class="n">strHeader</span> <span class="o">+=</span> <span class="n">rest_of_request</span>
</span><span class='line'>        <span class="n">fileobj</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">strHeader</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Part 7: Cache Write</h2>

<p>Caching sederhana saja. Simpan segalanya di file. Tidak perlu membaca body, cukup simpan segala responsenya. Memang ini bukan praktik yang bagus, tetapi kita ingin mendapatkan segalanya serba cepat.</p>

<p>Dan, di sini saya tidak akan membuat hirarki cache dalam bentuk folder. Ini akan menambah kerumitan apabila dia ada parameter GET, atau URL ada informasi yang diencode dalam unicode.</p>

<p>Btw, saya juga tidak menyimpan cache apabila dia bukan method GET. Ya, agar lebih menyenangkan saja. Mosok iya kita ngirim form, terus dibalasnya lewat cache. Ibarat anda upload tugas, kemudian hasilnya selalu upload berhasil padahal sebenarnya telah lewat deadline (hal ini karena proxy membaca dari cache).</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">request_name</span> <span class="o">!=</span> <span class="n">b</span><span class="s">&#39;POST&#39;</span><span class="p">):</span>
</span><span class='line'>          <span class="n">tmpFile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">&quot;./&quot;</span> <span class="o">+</span> <span class="n">full_path</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;/&quot;</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">),</span><span class="s">&quot;wb&quot;</span><span class="p">)</span>
</span><span class='line'>          <span class="n">tmpFile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
</span><span class='line'>          <span class="n">tmpFile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Part 3: Cache Read</h2>

<p>Tidak ada yang istimewa di sini ~</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'>    <span class="c"># Check wether the file exist in the cache</span>
</span><span class='line'>    <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">full_path</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;/&quot;</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">),</span> <span class="s">&quot;rb&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="n">fileExist</span> <span class="o">=</span> <span class="bp">True</span>
</span><span class='line'>    <span class="c"># ProxyServer finds a cache hit and generates a response message</span>
</span><span class='line'>    <span class="n">data</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</span><span class='line'>    <span class="k">print</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span><span class='line'>    <span class="n">tcpCliSock</span><span class="o">.</span><span class="n">sendall</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span><span class='line'>    <span class="c"># Fill in start.</span>
</span><span class='line'>    <span class="c"># Fill in end.</span>
</span><span class='line'>    <span class="k">print</span> <span class="p">(</span><span class="s">&quot;Read from cache&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="n">tcpCliSock</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Done!</h2>

<p>Ya, itu adalah penjelasan mengenai proxy jadi-jadian kita. Tidak sempurna memang, tetapi setidaknya Anda telah mengetahui bagaimana konsep HTTP bekerja.</p>

<h2>Some Trouble(shooting)</h2>

<ul>
<li>Saat menjalankan di linux, socket tidak ditutup secara langsung jika kita mematikan proses pythonnya. Entah itu yang disebut zombie atau apa, tetapi yang pasti saya masih harus <code>kill -9</code> atau <code>killall</code> agar proxynya dapat berjalan setelah sebelumnya dimatikan.</li>
<li>Dalam ngoding, saya kesulitan memahami tipe data Python. Akibatnya, saya menemui beberapa run time error terkait ini. Literal di python didefinisikan sebagai <code>L'sesuatu'</code> dengan <code>L</code> adalah simbol literalnya dan <code>sesuatu</code> adalah datanya. Anda tidak bisa melakukan concat (penggabungan) <code>b'Halo' + ' Dunia'</code>. Alih-alih, Anda harus melakukan penggabungan dalam tipe data yang sama</li>
<li>Program proxy di atas tidak sempurna dan hanya diuji membuka <code>mahasiswa.cs.ui.ac.id/~muhammad.mufid</code>. Saat membuka web-web yang kompleks (misalnya scele), program tidak berjalan dengan baik. Masalah concurrency, i18n, tidak ditangani dengan baik.</li>
<li>Melakukan decode dalam UTF-8 adalah ide yang buruk, tidak semua data diterima dalam UTF-8. Workaroundnya adalah hanya menggunakkan <code>byte</code> dalam setiap urusan pertukaran dan pemrosesan data.</li>
<li>Part 8, seharusnya saya isi apa?</li>
</ul>

</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Mufid</span></span>

      








  


<time datetime="2013-12-08T04:58:00+07:00" pubdate data-updated="true">Dec 8<span>th</span>, 2013</time>
      


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://mufid.github.io/2013/proxy-in-python-3/" data-via="" data-counturl="http://mufid.github.io/2013/proxy-in-python-3/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left articlenav" href="/blog/2013/banyak-orang-baik-di-indonesia/" title="Previous Post: Banyak Orang Baik di Indonesia">&laquo; Banyak Orang Baik di Indonesia</a>
      
      
        <a class="basic-alignment right articlenav" href="/blog/2014/twitter-wut/" title="Next Post: Twitter dan Kelucuannya">Twitter dan Kelucuannya &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    
  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2016 - Mufid -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'fidblog';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://mufid.github.io/blog/2013/proxy-in-python-3/';
        var disqus_url = 'http://mufid.github.io/blog/2013/proxy-in-python-3/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'https://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'https://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
